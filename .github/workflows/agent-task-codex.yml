name: Agent Task (Codex)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  implement:
    if: github.event.label.name == 'agent-codex'
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot (Codex)"
          git config user.email "actions@github.com"

      - name: Run OpenAI Codex to implement
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "ü§ñ Implementing issue #${ISSUE_NUMBER} with OpenAI Codex..."

          # Write issue body to temp file safely
          printf '%s' "$ISSUE_BODY" > /tmp/issue_body.txt

          # Build the prompt using printf to avoid shell interpretation
          printf '%s\n' \
            "You are implementing GitHub issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}" \
            "" \
            "Issue description:" \
            "$(cat /tmp/issue_body.txt)" \
            "" \
            "Instructions:" \
            "1. Create a feature branch named 'feature/codex-issue-${ISSUE_NUMBER}'" \
            "2. Implement the requested feature/refactoring exactly as described" \
            "3. Commit your changes with a clear, descriptive message" \
            "4. Push the branch using: git push -u origin feature/codex-issue-${ISSUE_NUMBER}" \
            "5. Create a PR using gh CLI that references 'Closes #${ISSUE_NUMBER}'" \
            "6. If there are tests, run them and ensure they pass" \
            "7. Post a brief status comment in the PR when done" \
            "" \
            "Work carefully and ensure all validation passes before marking as ready for review." \
            > /tmp/full_prompt.txt

          # Run Codex CLI in non-interactive mode (ChatGPT subscription-based)
          if command -v codex &> /dev/null; then
            # Use exec --full-auto for non-interactive automation with file editing
            codex exec --full-auto "$(cat /tmp/full_prompt.txt)"
          else
            echo "‚ùå Codex CLI not found. Please install with: npm install -g @openai/codex-cli"
            echo "Then authenticate with: codex login"
            exit 1
          fi

      - name: Verify PR was created
        run: |
          pr_count=$(gh pr list --repo ${{ github.repository }} --search "Closes #${{ github.event.issue.number }}" --json number --jq '. | length')
          if [ "$pr_count" -eq "0" ]; then
            echo "‚ö†Ô∏è  No PR was created for issue #${{ github.event.issue.number }}"
            echo "This might be expected for simple tasks that don't require PRs"
          else
            echo "‚úì PR successfully created for issue #${{ github.event.issue.number }}"
          fi

      - name: Post completion comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ Completed (Codex)' : '‚ùå Failed (Codex)';
            await github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${status}: Codex agent has finished processing this issue.`
            });
