name: Agent Task

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  implement:
    if: github.event.label.name == 'agent-task'
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Run Claude Code to implement
        run: |
          echo "Implementing issue #${{ github.event.issue.number }}..."
          claude -p "You are implementing GitHub issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

          Issue description:
          ${{ github.event.issue.body }}

          Instructions:
          1. Create a feature branch named 'feature/issue-${{ github.event.issue.number }}'
          2. Implement the requested feature/refactoring
          3. Commit your changes with a clear message
          4. Push the branch using: git push -u origin feature/issue-${{ github.event.issue.number }}
          5. Create a PR using gh CLI that references 'Closes #${{ github.event.issue.number }}'
          6. Wait for CI to complete by checking the PR status (if CI exists)
          7. If CI fails, read the logs, fix the issue, and push again (max 2 retries)
          8. Post a status comment in the PR when done

          Work carefully and ensure all tests pass before marking as ready for review." \
            --allowedTools "Read,Edit,Write,Bash,Glob,Grep,TodoWrite" \
            --max-turns 100

      - name: Verify PR was created
        run: |
          pr_count=$(gh pr list --repo ${{ github.repository }} --search "Closes #${{ github.event.issue.number }}" --json number --jq '. | length')
          if [ "$pr_count" -eq "0" ]; then
            echo "Error: No PR was created for issue #${{ github.event.issue.number }}"
            exit 1
          fi
          echo "✓ PR successfully created for issue #${{ github.event.issue.number }}"

      - name: Post completion comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅ Completed' : '❌ Failed';
            await github.rest.issues.createComment({
              issue_number: ${{ github.event.issue.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${status}: Agent has finished processing this issue. Check for a new PR.`
            });
