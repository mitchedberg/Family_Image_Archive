# Feature Matrix

| Feature | Bucket Review implementation | Face Queue implementation | Current behavior | Data dependencies | Extractable? | Proposed shared module |
| --- | --- | --- | --- | --- | --- | --- |
| Front / Back toggle | - `templates/review/review_app.js` → `setCompareMode`, `renderComparePane` render AI vs Back panes based on `state.compareMode`.<br>- Compare buttons stored in `localStorage` (`review_compare_mode`). | - `templates/faces_queue/queue_app.js` → `handlePhotoBackToggle`, `updatePhotoBackToggle` swap hero image and disable overlays while viewing handwriting.<br>- Uses per-photo `has_back/back_url` from `/api/photo/<bucket>/faces`. | Review: top toolbar toggles entire comparison pane (original vs AI or original vs back).<br>Photo Tagger: hero view button switches front/back for handwriting checks. | Review: `review_data.js` baked from SQLite/sidecar metadata; `bucket.has_back`, `web_back`, linked-back metadata.<br>Face Queue: `/api/photos`, `/api/photo/<bucket>/faces` supply `has_back`, `back_url`, plus `photo_priority_store`. | Yes | `ui/back_viewer.js` |
| Next / Prev navigation | - `nextBucket` / `prevBucket` in `review_app.js` adjust `state.index`, flush notes, re-render.<br>- Keyboard J/K map here. | - `stepPhotoSelection` in `queue_app.js` handles grid vs hero navigation, loads more when reaching end. | Review: sequential list of visible buckets; prev/next just reuses filtered dataset.<br>Photo Tagger: nav respects “grid vs hero”, loads additional pages when needed. | Review: dataset in `review_data.js`, `state.visible` filtered list.<br>Face Queue: `state.photo.items` from `/api/photos`, `loadPhotoGrid()` for pagination. | Partial (logic similar but grid state differs). | `ui/navigation.js` |
| Grid → hero → grid transitions | - N/A (Review always shows one bucket row; no thumbnail grid). | - `showPhotoGrid`, `openPhotoHero` in `queue_app.js` manage scroll position, hero metadata, status messaging. | Review: vertical list, active row highlighted.<br>Photo Tagger: grid of thumbnails with load-more + hero pane, remembers scroll. | Review: `bucketContainer` DOM only.<br>Face Queue: `/api/photos` feed + `state.photo.gridScrollTop`. | Partial | `ui/image_viewer.js` |
| Zoom / object-fit behavior | - `setupZoomControls`, `applyZoomTransform`, pointer handlers & pan state in `review_app.js` scale `.zoom-canvas` images (handles back rotation). | - `applyPhotoZoom`, CSS vars `--photo-hero-zoom` + slider/buttons in `queue_app.js`; overlays recompute via `ResizeObserver`. | Review: single global zoom/pan persisted per bucket session; affects both panes simultaneously.<br>Photo Tagger: per-hero zoom stored in `localStorage`, simpler contain logic. | Review: `localStorage(review_zoom/review_pan)`, DOM `.zoom-wrapper` nodes.<br>Face Queue: `PHOTO_ZOOM_STORAGE_KEY`, `state.photo.zoom`, hero container. | Yes | `ui/zoom_controller.js` |
| Keep scroll position (no jump) | - Stage not virtualized; uses `window.scrollTo(0,0)` on load and doesn’t preserve note drawer scroll when toggling.<br>- Prefetch logic keeps memory warm but not scroll state. | - `state.photo.gridScrollTop` saved in `showPhotoGrid`, restored with `requestAnimationFrame`; grid lives in its own scroll container. | Review: when notes expand/collapse page may jump.<br>Photo Tagger: returning from hero to grid keeps last scroll offset. | Review: DOM only (no API).<br>Face Queue: `photo-grid-view` container, `Load More` triggers API. | Partial | `ui/scroll_memory.js` |
| Face tagging interactions | - Bucket Review decisions: `applyDecision('prefer_ai' | 'prefer_original' | 'flag_creepy')` operate at bucket level; no per-face tagging. | - `assignFaceToActiveLabel`, `renderPhotoFaceList`, `renderPhotoOverlay` handle face-level selection + label assignment via `/api/queue/accept`. | Review: user chooses which variant to keep, marks OCR status, records notes. | Review: `ai_choices.csv`, sidecar metadata, `_handle_decision` endpoint, manual notes. | No (different intent). | — |
| Photo-level tagging | - Mark OCR status (`markOcrStatus`), `mark draft/verified`, `DecisionStore`. | - Priority triage via `setPhotoPriority` toggles `photo_priority.json`; verifying faces reduces `unlabeled_count`. | Review: bucket-level status & notes. Face Tagger: priority high/normal/low plus per-face assign. | Review: `ai_choices.csv`, sidecar `ocr_status`, `voice_transcripts` merge.<br>Face Queue: `/api/photo/priority`, `photo_priority_store`. | No (semantics differ) | — |
| Notes drawer / persistence | - Entire drawer in `templates/review/index.html` + `review_app.js` (`setupNoteEditor`, `note-add-button`). Saves to `ai_choices.csv` + sidecar human OCR via `_handle_decision`. | - Not present yet (face queue simply shows face list). | Review: read-only voice/OCR panels + manual notes editing with lock/unlock. | Review: `config/ai_choices.csv`, `review_note` in sidecar, `voice_sessions` JSON. | Yes (if reused later) | `ui/note_drawer.js` |
| Priority / triage controls | - Not implemented. | - `photo_priority_toggle` buttons call `/api/photo/priority`; backend `PhotoPriorityStore`. | Face queue supports per-photo backlog triage (High/Normal/Low) that influences grid sort/filter. | Face Queue: `config/photo_priority.json`, API `/api/photo/priority`. | N/A | — |
| bbox → pixel mapping | - Review: no bbox overlays; zoom/pan is canvas-wide. | - `getRenderedImageRect`, `positionBoundingBox` (via shared overlay helper) compute offsets for each face overlay (normalized 0–1). | Review: user compares entire images manually.<br>Photo Tagger: multi-face overlay uses normalized bbox data from SQLite. | Face Queue: `/api/photo/<bucket>/faces` returns normalized bbox; JS converts to px. | Yes | `ui/overlay_math.js` |
| Resize behavior | - Zoom wrappers rely on CSS transforms; no `ResizeObserver`. Rotated backs require `getRotationFitScale` to keep letterboxed fit. | - `installPhotoOverlayObserver` uses `ResizeObserver` to re-render overlays when hero resizes; zoom slider recalculates CSS var height. | Review: manual zoom may misalign after layout change until user adjusts.<br>Photo Tagger: overlay Math re-runs after container resize and zoom adjustments. | DOM only for both. | Yes | `ui/resize_adapter.js` |
| Multi-face overlay rendering | - Not available. | - `renderCandidateFacesOverlay` draws `.candidate-face-box` nodes for every detection, color-coded by assignment state. | Only Photo Tagger shows face-state colors (blue active, yellow unlabeled, green labeled). | Face Queue: `state.photo.faces` from `/api/photo/<bucket>/faces`. | Yes | `ui/face_overlay_layer.js` |
| OCR rendering | - `review_app.js` populates OCR tab from `bucket.auto_ocr`, allows copying to manual notes; can trigger OCR via `/api/ocr` endpoint (Apple Vision). | - Currently Photo Tagger does not surface OCR; planned integration is to reuse read-only data. | Review: voice + OCR displayed in drawer; can copy to manual note; storing updated status via `_handle_decision`. | Review: dataset fields `auto_ocr`, `human_ocr`, manual note in `ai_choices`. | Partial (only one UI) | `ui/ocr_panel.js` |
| Show-back-because-handwriting logic | - If compare mode = back and bucket lacks `web_back`, UI warns “No back image attached”; also surfaces “Linked back bucket” note when fastfoto link applied; `ocr-back-button` copies OCR to manual panel. | - Back toggle primarily for handwriting reference; overlays disabled to avoid obstruction. | Review: pressing “OCR Back → Notes” writes auto OCR into manual text. | Review: `bucket.auto_ocr.back_text`, `markOcrStatus`. Face queue needs only `back_url`. | Yes (shared heuristics). | `ui/back_handwriting.js` |
| Image resolution helper | - Backend `_find_variant_path` reads `bkt_<prefix>/sidecar.json` to locate raw/proxy/AI/back. | - Backend `_bucket_asset_url` builds `/buckets/bkt_<prefix>/derived/web_*` paths, verifying existence before returning. | Both UIs need consistent derived asset resolution; currently two implementations maintain similar logic separately. | Review: derived assets built via `ensure_web_images` and stored relative to staging root.<br>Face Queue: derived jpgs served directly from working directory. | Yes | `lib/bucket_assets.py` |
| API endpoints | - Review UI served dataset via static `review_data.js`; API endpoints: `/api/decision`, `/api/reveal`, `/api/ocr`, `/api/state_update`, `/api/fullres`. | - Face Queue server exposes `/api/queue/next`, `/api/queue/accept`, `/api/queue/skip`, `/api/people`, `/api/photos`, `/api/photo/<bucket>/faces`, `/api/photo/priority`, `/api/unlabeled`, etc. | Review mostly offline dataset with a few POST endpoints; face queue is API-driven with JSON fetch for everything. | Review: interacts with `ai_choices.csv`, bucket sidecars.<br>Face Queue: `face_tags.csv`, `face_votes.csv`, `face_people.json`, `photo_priority.json`, `face_embeddings.db`. | Partial (some concepts overlapping) | `api/photo_context.py` |
